import { describe, expect, it, beforeAll, afterAll } from "vitest";
import request from "supertest";
import app from "../server.mjs";
import resetCountries from "../scripts/resetCountries.mjs";
import mongoose from "mongoose";

const generarNombreUnico = () => {
  const letras = "abcdefghijklmnopqrstuvwxyz";
  const random = () =>
    Array.from({ length: 6 }, () => letras[Math.floor(Math.random() * letras.length)]).join("");
  return `Testlandia ${random().toUpperCase()}`;
};

beforeAll(async () => {
  await resetCountries();
});

afterAll(async () => {
  await mongoose.connection.close();
});

describe("‚úÖ API de Pa√≠ses - Test Exhaustivo y Validaci√≥n Profunda", () => {
  const nombreOficial = generarNombreUnico();
  const datosValidos = {
    name: { official: nombreOficial },
    capital: "Test√≥polis",
    borders: ["ARG", "CHL"], 
    area: 12345.67,
    population: 7890123,
    gini: 45.6,
    timezones: "UTC-03:00",
    flags: {
      svg: "https://test.com/bandera.svg",
      png: "https://test.com/bandera.png",
    },
    creador: "Tester Profesional",
  };

  const endpoint = "/api/countries/agregar";

  const testInvalido = async (campo, payloadMod, mensajeEsperado) => {
    const payload = { ...datosValidos, ...payloadMod };
    const res = await request(app)
      .post(endpoint)
      .set("Accept", "application/json")
      .send(payload);

    expect(res.statusCode).toBe(400);
    expect(res.body.errors).toBeDefined();

    if (mensajeEsperado) {
      expect(res.body.errors.some((e) => e.msg === mensajeEsperado)).toBe(true);
    } else {
      expect(res.body.errors.some((e) => e.path?.includes(campo))).toBe(true);
    }
  };

  describe("‚ùå Validaciones individuales", () => {
    it("‚ùå name.official con malas palabras", () =>
      testInvalido("name.official", { name: { official: "Pa√≠s-pendejo" } }, "El Nombre oficial solo puede contener letras y espacios.")
    );

    it("‚ùå capital con malas palabras", () =>
      testInvalido("capital", { capital: "Capital-puto" }, "La capital solo puede contener letras y espacios.")
    );

    it("‚ùå creador con malas palabras", () =>
      testInvalido("creador", { creador: "creador-boludo" }, "El creador solo puede contener letras y espacios. Ej: Juan P√©rez")
    );

    it("‚ùå name.official vac√≠o", () => testInvalido("name.official", { name: { official: "" } }));
    it("‚ùå name.official con n√∫meros", () => testInvalido("name.official", { name: { official: "Pa√≠s 123" } }));
    it("‚ùå name.official con emojis", () => testInvalido("name.official", { name: { official: "üåé Pa√≠s" } }));
    it("‚ùå capital vac√≠a", () => testInvalido("capital", { capital: "" }));
    it("‚ùå capital con n√∫meros", () => testInvalido("capital", { capital: "Capital123" }));
    it("‚ùå capital con emojis", () => testInvalido("capital", { capital: "Ciudad üåÜ" }));
    it("‚ùå borders con c√≥digo inv√°lido", () => testInvalido("borders", { borders: ["ARG", "xx", "123"] }));
    it("‚ùå borders con duplicados", () => testInvalido("borders", { borders: ["ARG", "ARG", "CHL"] }));
    it("‚ùå area negativa", () => testInvalido("area", { area: -100 }));
    it("‚ùå area como texto", () => testInvalido("area", { area: "mucho" }));
    it("‚ùå area con emojis", () => testInvalido("area", { area: "1000üåç" }));
    it("‚ùå population negativa", () => testInvalido("population", { population: -500 }));
    it("‚ùå population decimal", () => testInvalido("population", { population: 1234.56 }));
    it("‚ùå population como string", () => testInvalido("population", { population: "millones" }));
    it("‚ùå population con emojis", () => testInvalido("population", { population: "1000üë•" }));
    it("‚ùå gini menor a 0", () => testInvalido("gini", { gini: -1 }));
    it("‚ùå gini mayor a 100", () => testInvalido("gini", { gini: 150 }));
    it("‚ùå gini con texto", () => testInvalido("gini", { gini: "equilibrado" }));
    it("‚ùå gini con emojis", () => testInvalido("gini", { gini: "50üßÆ" }));
    it("‚ùå timezones con formato inv√°lido", () => testInvalido("timezones", { timezones: "GMT-3" }));
    it("‚ùå timezones vac√≠o", () => testInvalido("timezones", { timezones: "" }));
    it("‚ùå flags.svg inv√°lido", () => testInvalido("flags.svg", { flags: { ...datosValidos.flags, svg: "ftp://no-url" } }));
    it("‚ùå flags.png inv√°lido", () => testInvalido("flags.png", { flags: { ...datosValidos.flags, png: "no-es-url" } }));
    it("‚ùå creador vac√≠o", () => testInvalido("creador", { creador: "" }));
    it("‚ùå creador con n√∫meros", () => testInvalido("creador", { creador: "Leo123" }));
    it("‚ùå creador con emojis", () => testInvalido("creador", { creador: "Augusto üë®‚Äçüíª" }));
  });

  describe("‚úÖ Operaciones v√°lidas", () => {
    it("‚úÖ Crear y eliminar pa√≠s v√°lido", async () => {
      const resCrear = await request(app)
        .post(endpoint)
        .set("Accept", "application/json")
        .send(datosValidos);

      expect(resCrear.statusCode).toBe(201);
      expect(resCrear.body.data.name.official).toBe(nombreOficial);
      const idCreado = resCrear.body.data.id; 

      const resEliminar = await request(app)
        .delete(`/api/countries/${idCreado}`)
        .set("Accept", "application/json");

      expect(resEliminar.statusCode).toBe(200);
      expect(resEliminar.body.mensaje).toBe("Pa√≠s eliminado correctamente.");
    });
  });
});
